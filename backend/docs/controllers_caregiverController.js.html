<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>controllers/caregiverController.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Admin.html">Admin</a><ul class='methods'><li data-type='method'><a href="Admin.html#canBeDeactivated">canBeDeactivated</a></li><li data-type='method'><a href="Admin.html#canBeReactivated">canBeReactivated</a></li><li data-type='method'><a href="Admin.html#canBeSuspended">canBeSuspended</a></li><li data-type='method'><a href="Admin.html#canBeUnsuspended">canBeUnsuspended</a></li><li data-type='method'><a href="Admin.html#isActive">isActive</a></li><li data-type='method'><a href="Admin.html#isDeactivated">isDeactivated</a></li><li data-type='method'><a href="Admin.html#isManageableByAdmin">isManageableByAdmin</a></li><li data-type='method'><a href="Admin.html#isSuspended">isSuspended</a></li><li data-type='method'><a href="Admin.html#.validate">validate</a></li></ul></li><li><a href="AdminController.html">AdminController</a><ul class='methods'><li data-type='method'><a href="AdminController.html#announceServiceOutage">announceServiceOutage</a></li><li data-type='method'><a href="AdminController.html#deactivateUser">deactivateUser</a></li><li data-type='method'><a href="AdminController.html#getAdminLogs">getAdminLogs</a></li><li data-type='method'><a href="AdminController.html#getAllReports">getAllReports</a></li><li data-type='method'><a href="AdminController.html#getAllReviews">getAllReviews</a></li><li data-type='method'><a href="AdminController.html#getAllUsers">getAllUsers</a></li><li data-type='method'><a href="AdminController.html#getDashboardStats">getDashboardStats</a></li><li data-type='method'><a href="AdminController.html#getUserById">getUserById</a></li><li data-type='method'><a href="AdminController.html#reactivateUser">reactivateUser</a></li><li data-type='method'><a href="AdminController.html#reassignVolunteer">reassignVolunteer</a></li><li data-type='method'><a href="AdminController.html#rejectReport">rejectReport</a></li><li data-type='method'><a href="AdminController.html#removeReview">removeReview</a></li><li data-type='method'><a href="AdminController.html#resolveReport">resolveReport</a></li><li data-type='method'><a href="AdminController.html#startReportReview">startReportReview</a></li><li data-type='method'><a href="AdminController.html#suspendUser">suspendUser</a></li><li data-type='method'><a href="AdminController.html#unsuspendUser">unsuspendUser</a></li></ul></li><li><a href="AdminService.html">AdminService</a><ul class='methods'><li data-type='method'><a href="AdminService.html#deactivateUser">deactivateUser</a></li><li data-type='method'><a href="AdminService.html#getAdminLogs">getAdminLogs</a></li><li data-type='method'><a href="AdminService.html#getAllUsers">getAllUsers</a></li><li data-type='method'><a href="AdminService.html#getDashboardStats">getDashboardStats</a></li><li data-type='method'><a href="AdminService.html#logAdminAction">logAdminAction</a></li><li data-type='method'><a href="AdminService.html#reactivateUser">reactivateUser</a></li><li data-type='method'><a href="AdminService.html#suspendUser">suspendUser</a></li><li data-type='method'><a href="AdminService.html#unsuspendUser">unsuspendUser</a></li></ul></li><li><a href="Caregiver.html">Caregiver</a><ul class='methods'><li data-type='method'><a href="Caregiver.html#canBeDeactivated">canBeDeactivated</a></li><li data-type='method'><a href="Caregiver.html#canBeReactivated">canBeReactivated</a></li><li data-type='method'><a href="Caregiver.html#canBeSuspended">canBeSuspended</a></li><li data-type='method'><a href="Caregiver.html#canBeUnsuspended">canBeUnsuspended</a></li><li data-type='method'><a href="Caregiver.html#isActive">isActive</a></li><li data-type='method'><a href="Caregiver.html#isDeactivated">isDeactivated</a></li><li data-type='method'><a href="Caregiver.html#isManageableByAdmin">isManageableByAdmin</a></li><li data-type='method'><a href="Caregiver.html#isSuspended">isSuspended</a></li><li data-type='method'><a href="Caregiver.html#.validate">validate</a></li></ul></li><li><a href="CaregiverController.html">CaregiverController</a><ul class='methods'><li data-type='method'><a href="CaregiverController.html#.getActiveTrips">getActiveTrips</a></li><li data-type='method'><a href="CaregiverController.html#.getElderlyLocation">getElderlyLocation</a></li><li data-type='method'><a href="CaregiverController.html#.getElderlyLocationHistory">getElderlyLocationHistory</a></li><li data-type='method'><a href="CaregiverController.html#.getLinkedElderly">getLinkedElderly</a></li><li data-type='method'><a href="CaregiverController.html#.linkByPIN">linkByPIN</a></li><li data-type='method'><a href="CaregiverController.html#.me">me</a></li><li data-type='method'><a href="CaregiverController.html#.requestHistory">requestHistory</a></li><li data-type='method'><a href="CaregiverController.html#.submitReport">submitReport</a></li><li data-type='method'><a href="CaregiverController.html#.updateElderlyProfile">updateElderlyProfile</a></li><li data-type='method'><a href="CaregiverController.html#.updateProfile">updateProfile</a></li></ul></li><li><a href="Elderly.html">Elderly</a><ul class='methods'><li data-type='method'><a href="Elderly.html#canBeDeactivated">canBeDeactivated</a></li><li data-type='method'><a href="Elderly.html#canBeReactivated">canBeReactivated</a></li><li data-type='method'><a href="Elderly.html#canBeSuspended">canBeSuspended</a></li><li data-type='method'><a href="Elderly.html#canBeUnsuspended">canBeUnsuspended</a></li><li data-type='method'><a href="Elderly.html#canGenerateLinkPIN">canGenerateLinkPIN</a></li><li data-type='method'><a href="Elderly.html#generateNewPIN">generateNewPIN</a></li><li data-type='method'><a href="Elderly.html#isActive">isActive</a></li><li data-type='method'><a href="Elderly.html#isDeactivated">isDeactivated</a></li><li data-type='method'><a href="Elderly.html#isManageableByAdmin">isManageableByAdmin</a></li><li data-type='method'><a href="Elderly.html#isSuspended">isSuspended</a></li><li data-type='method'><a href="Elderly.html#.validate">validate</a></li></ul></li><li><a href="ElderlyController.html">ElderlyController</a><ul class='methods'><li data-type='method'><a href="ElderlyController.html#.completeTripTracking">completeTripTracking</a></li><li data-type='method'><a href="ElderlyController.html#.getLinkedCaregivers">getLinkedCaregivers</a></li><li data-type='method'><a href="ElderlyController.html#.getLinkingPIN">getLinkingPIN</a></li><li data-type='method'><a href="ElderlyController.html#.getProfile">getProfile</a></li><li data-type='method'><a href="ElderlyController.html#.regenerateLinkingPIN">regenerateLinkingPIN</a></li><li data-type='method'><a href="ElderlyController.html#.startTripTracking">startTripTracking</a></li><li data-type='method'><a href="ElderlyController.html#.updateLanguagePreference">updateLanguagePreference</a></li><li data-type='method'><a href="ElderlyController.html#.updateLocation">updateLocation</a></li><li data-type='method'><a href="ElderlyController.html#.updateProfile">updateProfile</a></li></ul></li><li><a href="HelpRequest.html">HelpRequest</a><ul class='methods'><li data-type='method'><a href="HelpRequest.html#.createRequest">createRequest</a></li><li data-type='method'><a href="HelpRequest.html#.getCompletedHelpRequestswithVolunteer">getCompletedHelpRequestswithVolunteer</a></li></ul></li><li><a href="NotificationService.html">NotificationService</a><ul class='methods'><li data-type='method'><a href="NotificationService.html#broadcastToAllUsers">broadcastToAllUsers</a></li><li data-type='method'><a href="NotificationService.html#notifyAccountCreated">notifyAccountCreated</a></li><li data-type='method'><a href="NotificationService.html#notifyAccountDeactivated">notifyAccountDeactivated</a></li><li data-type='method'><a href="NotificationService.html#notifyAccountSuspended">notifyAccountSuspended</a></li><li data-type='method'><a href="NotificationService.html#notifyAccountUnsuspended">notifyAccountUnsuspended</a></li><li data-type='method'><a href="NotificationService.html#notifyAdminNewReportSubmitted">notifyAdminNewReportSubmitted</a></li><li data-type='method'><a href="NotificationService.html#notifyAdminNewUserRegistered">notifyAdminNewUserRegistered</a></li><li data-type='method'><a href="NotificationService.html#notifyAdminReportResolved">notifyAdminReportResolved</a></li><li data-type='method'><a href="NotificationService.html#notifyAdminReviewFlagged">notifyAdminReviewFlagged</a></li><li data-type='method'><a href="NotificationService.html#notifyAllAdmins">notifyAllAdmins</a></li><li data-type='method'><a href="NotificationService.html#notifyCaregiverAccountDeactivated">notifyCaregiverAccountDeactivated</a></li><li data-type='method'><a href="NotificationService.html#notifyCaregiverAccountSuspended">notifyCaregiverAccountSuspended</a></li><li data-type='method'><a href="NotificationService.html#notifyCaregiverAccountUnsuspended">notifyCaregiverAccountUnsuspended</a></li><li data-type='method'><a href="NotificationService.html#notifyCaregiverElderlyLinked">notifyCaregiverElderlyLinked</a></li><li data-type='method'><a href="NotificationService.html#notifyCaregiverHelpRequestCompleted">notifyCaregiverHelpRequestCompleted</a></li><li data-type='method'><a href="NotificationService.html#notifyCaregiverHelpRequestInitiated">notifyCaregiverHelpRequestInitiated</a></li><li data-type='method'><a href="NotificationService.html#notifyCaregiverHelpRequestMatched">notifyCaregiverHelpRequestMatched</a></li><li data-type='method'><a href="NotificationService.html#notifyCaregiverLinked">notifyCaregiverLinked</a></li><li data-type='method'><a href="NotificationService.html#notifyCaregiverProgressUpdate">notifyCaregiverProgressUpdate</a></li><li data-type='method'><a href="NotificationService.html#notifyCaregiverReportUpdate">notifyCaregiverReportUpdate</a></li><li data-type='method'><a href="NotificationService.html#notifyFeatureUpdate">notifyFeatureUpdate</a></li><li data-type='method'><a href="NotificationService.html#notifyHelpRequestCancelled">notifyHelpRequestCancelled</a></li><li data-type='method'><a href="NotificationService.html#notifyHelpRequestCompleted">notifyHelpRequestCompleted</a></li><li data-type='method'><a href="NotificationService.html#notifyHelpRequestCreated">notifyHelpRequestCreated</a></li><li data-type='method'><a href="NotificationService.html#notifyHelpRequestMatched">notifyHelpRequestMatched</a></li><li data-type='method'><a href="NotificationService.html#notifyReportUpdate">notifyReportUpdate</a></li><li data-type='method'><a href="NotificationService.html#notifyReviewReminder">notifyReviewReminder</a></li><li data-type='method'><a href="NotificationService.html#notifyScheduledMaintenance">notifyScheduledMaintenance</a></li><li data-type='method'><a href="NotificationService.html#notifyServiceOutage">notifyServiceOutage</a></li><li data-type='method'><a href="NotificationService.html#notifyVolunteerAccountDeactivated">notifyVolunteerAccountDeactivated</a></li><li data-type='method'><a href="NotificationService.html#notifyVolunteerAccountSuspended">notifyVolunteerAccountSuspended</a></li><li data-type='method'><a href="NotificationService.html#notifyVolunteerAccountUnsuspended">notifyVolunteerAccountUnsuspended</a></li><li data-type='method'><a href="NotificationService.html#notifyVolunteerNewRequestNearby">notifyVolunteerNewRequestNearby</a></li><li data-type='method'><a href="NotificationService.html#notifyVolunteerReportUpdate">notifyVolunteerReportUpdate</a></li><li data-type='method'><a href="NotificationService.html#notifyVolunteerRequestAssigned">notifyVolunteerRequestAssigned</a></li><li data-type='method'><a href="NotificationService.html#notifyVolunteerRequestCancelled">notifyVolunteerRequestCancelled</a></li><li data-type='method'><a href="NotificationService.html#notifyVolunteerRequestCompleted">notifyVolunteerRequestCompleted</a></li><li data-type='method'><a href="NotificationService.html#sendAdminNotification">sendAdminNotification</a></li><li data-type='method'><a href="NotificationService.html#sendCaregiverNotification">sendCaregiverNotification</a></li><li data-type='method'><a href="NotificationService.html#sendNotification">sendNotification</a></li><li data-type='method'><a href="NotificationService.html#sendVolunteerNotification">sendVolunteerNotification</a></li></ul></li><li><a href="ReportController.html">ReportController</a></li><li><a href="ReportService.html">ReportService</a><ul class='methods'><li data-type='method'><a href="ReportService.html#addEvidence">addEvidence</a></li><li data-type='method'><a href="ReportService.html#beginReview">beginReview</a></li><li data-type='method'><a href="ReportService.html#getAllReportsForAdmin">getAllReportsForAdmin</a></li><li data-type='method'><a href="ReportService.html#getEvidenceUploadMiddleware">getEvidenceUploadMiddleware</a></li><li data-type='method'><a href="ReportService.html#rejectReport">rejectReport</a></li><li data-type='method'><a href="ReportService.html#resolveReport">resolveReport</a></li><li data-type='method'><a href="ReportService.html#submitReport">submitReport</a></li><li data-type='method'><a href="ReportService.html#viewMyReports">viewMyReports</a></li></ul></li><li><a href="ReviewController.html">ReviewController</a></li><li><a href="ReviewService.html">ReviewService</a><ul class='methods'><li data-type='method'><a href="ReviewService.html#editReview">editReview</a></li><li data-type='method'><a href="ReviewService.html#flagReview">flagReview</a></li><li data-type='method'><a href="ReviewService.html#getAllReviewsForAdmin">getAllReviewsForAdmin</a></li><li data-type='method'><a href="ReviewService.html#removeReview">removeReview</a></li><li data-type='method'><a href="ReviewService.html#submitReview">submitReview</a></li><li data-type='method'><a href="ReviewService.html#viewMyReviews">viewMyReviews</a></li><li data-type='method'><a href="ReviewService.html#viewReviewsAboutMe">viewReviewsAboutMe</a></li></ul></li><li><a href="RouteHistoryService.html">RouteHistoryService</a><ul class='methods'><li data-type='method'><a href="RouteHistoryService.html#.deleteRouteHistory">deleteRouteHistory</a></li><li data-type='method'><a href="RouteHistoryService.html#.getRouteHistory">getRouteHistory</a></li><li data-type='method'><a href="RouteHistoryService.html#.getRouteStatistics">getRouteStatistics</a></li><li data-type='method'><a href="RouteHistoryService.html#.saveRouteHistory">saveRouteHistory</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#canBeDeactivated">canBeDeactivated</a></li><li data-type='method'><a href="User.html#canBeReactivated">canBeReactivated</a></li><li data-type='method'><a href="User.html#canBeSuspended">canBeSuspended</a></li><li data-type='method'><a href="User.html#canBeUnsuspended">canBeUnsuspended</a></li><li data-type='method'><a href="User.html#isActive">isActive</a></li><li data-type='method'><a href="User.html#isDeactivated">isDeactivated</a></li><li data-type='method'><a href="User.html#isManageableByAdmin">isManageableByAdmin</a></li><li data-type='method'><a href="User.html#isSuspended">isSuspended</a></li><li data-type='method'><a href="User.html#.findById">findById</a></li><li data-type='method'><a href="User.html#.getAll">getAll</a></li><li data-type='method'><a href="User.html#.update">update</a></li><li data-type='method'><a href="User.html#.validate">validate</a></li></ul></li><li></li><li></li><li><a href="Volunteer.html">Volunteer</a><ul class='methods'><li data-type='method'><a href="Volunteer.html#canBeDeactivated">canBeDeactivated</a></li><li data-type='method'><a href="Volunteer.html#canBeReactivated">canBeReactivated</a></li><li data-type='method'><a href="Volunteer.html#canBeSuspended">canBeSuspended</a></li><li data-type='method'><a href="Volunteer.html#canBeUnsuspended">canBeUnsuspended</a></li><li data-type='method'><a href="Volunteer.html#isActive">isActive</a></li><li data-type='method'><a href="Volunteer.html#isDeactivated">isDeactivated</a></li><li data-type='method'><a href="Volunteer.html#isManageableByAdmin">isManageableByAdmin</a></li><li data-type='method'><a href="Volunteer.html#isSuspended">isSuspended</a></li><li data-type='method'><a href="Volunteer.html#.validate">validate</a></li></ul></li><li><a href="VolunteerController.html">VolunteerController</a><ul class='methods'><li data-type='method'><a href="VolunteerController.html#.acceptRequest">acceptRequest</a></li><li data-type='method'><a href="VolunteerController.html#.cancelRequest">cancelRequest</a></li><li data-type='method'><a href="VolunteerController.html#.completeRequest">completeRequest</a></li><li data-type='method'><a href="VolunteerController.html#.getAcceptedRequest">getAcceptedRequest</a></li><li data-type='method'><a href="VolunteerController.html#.getFilteredRequests">getFilteredRequests</a></li><li data-type='method'><a href="VolunteerController.html#.getPendingRequest">getPendingRequest</a></li><li data-type='method'><a href="VolunteerController.html#.getProfile">getProfile</a></li><li data-type='method'><a href="VolunteerController.html#.sendProgressUpdate">sendProgressUpdate</a></li><li data-type='method'><a href="VolunteerController.html#.updateProfile">updateProfile</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="CaregiverServices.html">CaregiverServices</a><ul class='methods'><li data-type='method'><a href="CaregiverServices.html#.getLinkedElderly">getLinkedElderly</a></li><li data-type='method'><a href="CaregiverServices.html#.linkToElderlyByPIN">linkToElderlyByPIN</a></li></ul></li><li><a href="ElderlyServices.html">ElderlyServices</a><ul class='methods'><li data-type='method'><a href="ElderlyServices.html#.getLinkedCaregivers">getLinkedCaregivers</a></li><li data-type='method'><a href="ElderlyServices.html#.getLinkingPIN">getLinkingPIN</a></li><li data-type='method'><a href="ElderlyServices.html#.regenerateLinkingPIN">regenerateLinkingPIN</a></li><li data-type='method'><a href="ElderlyServices.html#.updateProfile">updateProfile</a></li></ul></li><li><a href="VolunteerServices.html">VolunteerServices</a></li></ul><h3>Global</h3><ul><li><a href="global.html#acceptRequest">acceptRequest</a></li><li><a href="global.html#completeRequest">completeRequest</a></li><li><a href="global.html#deleteProfile">deleteProfile</a></li><li><a href="global.html#getAllUsers">getAllUsers</a></li><li><a href="global.html#getPendingRequests">getPendingRequests</a></li><li><a href="global.html#getProfile">getProfile</a></li><li><a href="global.html#sanitize">sanitize</a></li><li><a href="global.html#updateProfile">updateProfile</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/caregiverController.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const CaregiverServices = require('../services/caregiver');
const Caregiver = require('../domain/caregiver');
const {supabase} = require('../config/supabase');
const Role = require('../domain/enum/Role');
const { getReceiverSocketId, io } = require('../middleware/socket');

/**
 * Caregiver Controller
 * Handles HTTP requests for caregiver operations
 * Provides endpoints for linking to elderly users, viewing linked elderly, and monitoring their activities
 * All methods require caregiver authentication
 * 
 * @class CaregiverController
 * @example
 * // Used in routes: router.get('/me', CaregiverController.me);
 */
class CaregiverController {
  /**
   * Get caregiver profile with linked elderly users
   * @route GET /api/caregiver/me
   * @access Private (Caregiver only)
   * @param {Request} req - Express request object
   * @param {string} req.user.id - Caregiver user ID (from authentication)
   * @param {Response} res - Express response object
   * @returns {Object} 200 - Caregiver data with linked elderly list
   * @returns {Object} 500 - Server error
   */
  static async me(req, res) {
    try {
      // Get linked elderly data - using consistent naming with frontend
      const linkedElderly = await CaregiverServices.getLinkedElderly(req.user.id);
      
      res.json({ 
        linked_elderly: linkedElderly 
      });
    } catch (e) { 
      console.error('Error in caregiver/me:', e);
      res.status(500).json({ error: e.message }); 
    }
  }

  /**
   * Update caregiver profile
   * @route PUT /api/caregiver/profile
   * @access Private (Caregiver only)
   * @param {Request} req - Express request object
   * @param {string} req.user.id - Caregiver user ID (from authentication)
   * @param {Object} req.body - Profile updates
   * @param {Response} res - Express response object
   * @returns {Object} 200 - Updated profile
   * @returns {Object} 400 - Validation errors
   */
  static async updateProfile(req, res) {
    try {
      // Pull current profile to validate merged data (optional but clean)
      const updates = req.body || {};
      const merged = { ...updates, role: 'CAREGIVER' };
      const { isValid, errors } = Caregiver.validate(merged);
      if (!isValid) return res.status(400).json({ errors });

      const updated = await CaregiverServices.updateProfile(req.user.id, updates);
      res.json({ message: 'Profile updated', profile: updated });
    } catch (e) { res.status(400).json({ error: e.message }); }
  }

  /**
   * Update linked elderly user's profile
   * @route PUT /api/caregiver/elderly/:elderlyUserId/profile
   * @access Private (Caregiver only, must be linked to elderly)
   * @param {Request} req - Express request object
   * @param {string} req.user.id - Caregiver user ID (from authentication)
   * @param {string} req.params.elderlyUserId - Elderly user ID to update
   * @param {Object} req.body - Profile updates
   * @param {Response} res - Express response object
   * @returns {Object} 200 - Elderly profile updated
   * @returns {Object} 403 - Not authorized (not linked to this elderly)
   * @returns {Object} 400 - Validation errors
   */
  static async updateElderlyProfile(req, res) {
    try {
      const { elderlyUserId } = req.params;
      const updates = req.body || {};
      
      // Verify the elderly user is linked to this caregiver
      const linkedElderly = await CaregiverServices.getLinkedElderly(req.user.id);
      const isLinked = linkedElderly.some(elderly => elderly.user_id === elderlyUserId);
      
      if (!isLinked) {
        return res.status(403).json({ error: 'Not authorized to update this elderly user profile' });
      }
      
      const updated = await CaregiverServices.updateElderlyProfile(elderlyUserId, updates);
      res.json({ message: 'Elderly profile updated', profile: updated });
    } catch (e) { 
      console.error('Error updating elderly profile:', e);
      res.status(400).json({ error: e.message }); 
    }
  }

  /**
   * Link caregiver to elderly user using PIN
   * @route POST /api/caregiver/link
   * @access Private (Caregiver only)
   * @param {Request} req - Express request object
   * @param {string} req.user.id - Caregiver user ID (from authentication)
   * @param {Object} req.body - Link data
   * @param {string} req.body.pin - 6-digit linking PIN from elderly user
   * @param {Response} res - Express response object
   * @returns {Object} 201 - Successfully linked
   * @returns {Object} 400 - Invalid PIN or missing PIN
   */
  static async linkByPIN(req, res) {
    try {
      const { pin } = req.body || {};
      if (!pin) return res.status(400).json({ error: 'PIN is required' });
      const link = await CaregiverServices.linkToElderlyByPIN(req.user.id, pin);
      res.status(201).json({ message: 'Linked', link });
    } catch (e) { res.status(400).json({ error: e.message }); }
  }

  /**
   * Get all linked elderly users
   * @route GET /api/caregiver/elderly
   * @access Private (Caregiver only)
   * @param {Request} req - Express request object
   * @param {string} req.user.id - Caregiver user ID (from authentication)
   * @param {Response} res - Express response object
   * @returns {Object} 200 - Array of linked elderly profiles
   * @returns {Object} 500 - Server error
   */
  static async getLinkedElderly(req, res) {
    try { res.json(await CaregiverServices.getLinkedElderly(req.user.id)); }
    catch (e) { res.status(500).json({ error: e.message }); }
  }

  /**
   * Submit a report on behalf of linked elderly user
   * @route POST /api/caregiver/report
   * @access Private (Caregiver only)
   * @param {Request} req - Express request object
   * @param {string} req.user.id - Caregiver user ID (from authentication)
   * @param {Object} req.body - Report data
   * @param {string} req.body.linkedElderlyUserId - Linked elderly user ID
   * @param {string} req.body.reportedVolunteerUserId - Volunteer user ID being reported
   * @param {Array} req.body.reasons - Array of report reasons
   * @param {string} [req.body.description] - Optional detailed description
   * @param {Response} res - Express response object
   * @returns {Object} 201 - Report created successfully
   * @returns {Object} 400 - Not linked to this elderly or missing required fields
   * @returns {Object} 500 - Server error
   */
  static async submitReport(req, res) {
    try {
      const report = await CaregiverServices.submitReport(req.user.id, req.body || {});
      res.status(201).json(report);
    } catch (e) { res.status(400).json({ error: e.message }); }
  }

  /**
   * Get help request history for a linked elderly user
   * @route GET /api/caregiver/elderly/:elderlyUserId/requests
   * @access Private (Caregiver only, must be linked to elderly)
   * @param {Request} req - Express request object
   * @param {string} req.user.id - Caregiver user ID (from authentication)
   * @param {string} req.params.elderlyUserId - Elderly user ID
   * @param {Object} req.query - Query parameters
   * @param {number} [req.query.limit=20] - Maximum results to return
   * @param {number} [req.query.offset=0] - Number of results to skip
   * @param {Response} res - Express response object
   * @returns {Object} 200 - Array of help requests
   * @returns {Object} 400 - Not linked to this elderly
   * @returns {Object} 500 - Server error
   */
  static async requestHistory(req, res) {
    try {
      const { elderlyUserId } = req.params;
      const { limit, offset } = req.query;
      const data = await CaregiverServices.getRequestHistory(
        req.user.id, elderlyUserId,
        { limit: Number(limit) || 20, offset: Number(offset) || 0 }
      );
      res.json(data);
    } catch (e) { res.status(400).json({ error: e.message }); }
  }

  /**
   * Get current location for a linked elderly user
   * @route GET /api/caregiver/elderly/:elderlyUserId/location
   * @access Private (Caregiver only)
   * @param {Request} req - Express request object
   * @param {string} req.user.id - Caregiver user ID (from authentication)
   * @param {string} req.params.elderlyUserId - ID of elderly user
   * @param {Response} res - Express response object
   * @returns {Object} 200 - Current location data
   * @returns {Object} 403 - Not authorized (not linked to this elderly)
   * @returns {Object} 404 - Location not found
   */
  static async getElderlyLocation(req, res) {
    try {
      const { elderlyUserId } = req.params;

      // Verify caregiver is linked to this elderly user
      const linkedElderly = await CaregiverServices.getLinkedElderly(req.user.id);
      const isLinked = linkedElderly.some(elderly => elderly.user_id === elderlyUserId);
      
      if (!isLinked) {
        return res.status(403).json({ error: 'Not authorized to view this elderly user\'s location' });
      }

      // Get current location
      const { data: location, error } = await supabase
        .from('elderly_locations')
        .select('*')
        .eq('elderly_id', elderlyUserId)
        .order('timestamp', { ascending: false })
        .limit(1)
        .single();

      if (error || !location) {
        return res.status(404).json({ error: 'No location data available for this user' });
      }

      // Get elderly user details
      const { data: elderlyProfile, error: profileError } = await supabase
        .from('user_profiles')
        .select('full_name, username')
        .eq('user_id', elderlyUserId)
        .single();

      const elderlyName = elderlyProfile?.full_name || elderlyProfile?.username || 'Unknown';

      res.json({
        success: true,
        data: {
          elderlyId: elderlyUserId,
          elderlyName,
          location: {
            lat: location.latitude,
            lng: location.longitude,
            accuracy: location.accuracy,
            timestamp: location.timestamp
          },
          tripContext: {
            tripId: location.trip_id,
            helpRequestId: location.help_request_id,
            status: location.status
          },
          metadata: location.metadata
        }
      });

    } catch (err) {
      console.error('Get elderly location error:', err);
      res.status(500).json({ error: err.message || 'Failed to get elderly location' });
    }
  }

  /**
   * Get location history for a linked elderly user
   */
  static async getElderlyLocationHistory(req, res) {
    try {
      const { elderlyUserId } = req.params;
      const { limit = 50, hours = 24 } = req.query;

      // Verify caregiver is linked to this elderly user
      const linkedElderly = await CaregiverServices.getLinkedElderly(req.user.id);
      const isLinked = linkedElderly.some(elderly => elderly.user_id === elderlyUserId);
      
      if (!isLinked) {
        return res.status(403).json({ error: 'Not authorized to view this elderly user\'s location history' });
      }

      // Get location history
      const hoursAgo = new Date(Date.now() - hours * 60 * 60 * 1000).toISOString();
      
      const { data: locations, error } = await supabase
        .from('elderly_locations')
        .select('*')
        .eq('elderly_id', elderlyUserId)
        .gte('timestamp', hoursAgo)
        .order('timestamp', { ascending: false })
        .limit(Number(limit));

      if (error) {
        console.error('Error fetching location history:', error);
        return res.status(500).json({ error: 'Failed to fetch location history' });
      }

      res.json({
        success: true,
        data: (locations || []).map(loc => ({
          location: {
            lat: loc.latitude,
            lng: loc.longitude,
            accuracy: loc.accuracy,
            timestamp: loc.timestamp
          },
          tripContext: {
            tripId: loc.trip_id,
            helpRequestId: loc.help_request_id,
            status: loc.status
          },
          metadata: loc.metadata
        }))
      });

    } catch (err) {
      console.error('Get elderly location history error:', err);
      res.status(500).json({ error: err.message || 'Failed to get location history' });
    }
  }

  /**
   * Get active trips for linked elderly users
   */
  static async getActiveTrips(req, res) {
    try {
      const linkedElderly = await CaregiverServices.getLinkedElderly(req.user.id);
      const elderlyIds = linkedElderly.map(elderly => elderly.user_id);

      if (elderlyIds.length === 0) {
        return res.json({ success: true, data: [] });
      }

      // Get active trips for all linked elderly users
      const { data: trips, error } = await supabase
        .from('elderly_trips')
        .select(`
          *,
          elderly:user_profiles!elderly_id (
            user_id,
            full_name,
            username
          )
        `)
        .in('elderly_id', elderlyIds)
        .eq('status', 'in_progress')
        .order('started_at', { ascending: false });

      if (error) {
        console.error('Error fetching active trips:', error);
        return res.status(500).json({ error: 'Failed to fetch active trips' });
      }

      const formattedTrips = (trips || []).map(trip => ({
        tripId: trip.id,
        elderlyId: trip.elderly_id,
        elderlyName: trip.elderly?.full_name || trip.elderly?.username || 'Unknown',
        origin: trip.origin,
        destination: trip.destination,
        tripType: trip.trip_type,
        status: trip.status,
        startedAt: trip.started_at,
        helpRequestId: trip.help_request_id,
        volunteerId: trip.volunteer_id
      }));

      res.json({ success: true, data: formattedTrips });

    } catch (err) {
      console.error('Get active trips error:', err);
      res.status(500).json({ error: err.message || 'Failed to get active trips' });
    }
  }
}

module.exports = CaregiverController;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Sat Nov 01 2025 20:03:33 GMT+0800 (Singapore Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
